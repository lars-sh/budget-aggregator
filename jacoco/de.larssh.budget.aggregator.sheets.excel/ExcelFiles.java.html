<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExcelFiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Budget Aggregator</a> &gt; <a href="index.source.html" class="el_package">de.larssh.budget.aggregator.sheets.excel</a> &gt; <span class="el_source">ExcelFiles.java</span></div><h1>ExcelFiles.java</h1><pre class="source lang-java linenums">// Generated by delombok at Tue Jun 10 02:52:42 UTC 2025
package de.larssh.budget.aggregator.sheets.excel;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.text.DecimalFormat;
import java.text.DecimalFormatSymbols;
import java.text.NumberFormat;
import java.util.HashMap;
import java.util.HashSet;
import java.util.IdentityHashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.Set;
import java.util.function.BiConsumer;
import org.apache.poi.hssf.usermodel.HSSFWorkbookFactory;
import org.apache.poi.ss.SpreadsheetVersion;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.ClientAnchor;
import org.apache.poi.ss.usermodel.Comment;
import org.apache.poi.ss.usermodel.CreationHelper;
import org.apache.poi.ss.usermodel.Font;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import org.apache.poi.ss.util.AreaReference;
import org.apache.poi.ss.util.CellReference;
import org.apache.poi.ss.util.CellUtil;
import org.apache.poi.ss.util.SheetUtil;
import org.apache.poi.xssf.usermodel.XSSFCell;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFTable;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbookFactory;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.CTCell;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.CTTable;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.CTTableColumn;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.STCellType;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.STTotalsRowFunction;
import de.larssh.budget.aggregator.data.Account;
import de.larssh.budget.aggregator.data.Balance;
import de.larssh.budget.aggregator.data.Budget;
import de.larssh.budget.aggregator.data.BudgetReference;
import de.larssh.budget.aggregator.data.BudgetType;
import de.larssh.budget.aggregator.data.Budgets;
import de.larssh.budget.aggregator.data.Product;
import de.larssh.budget.aggregator.sheets.csv.CsvFiles;
import de.larssh.utils.Finals;
import de.larssh.utils.Nullables;
import de.larssh.utils.OptionalInts;
import de.larssh.utils.annotations.PackagePrivate;
import de.larssh.utils.collection.Maps;
import de.larssh.utils.text.StringParseException;

@SuppressWarnings({&quot;PMD.CouplingBetweenObjects&quot;, &quot;PMD.ExcessiveImports&quot;})
public final class ExcelFiles {
	/**
	 * Remark: {@link ExcelSheet#isApplyBudgetTypeSign()} requires this constant to
	 * differ from {@link CsvFiles#COLUMN_NAME_MUNICIPALITY}.
	 */
	@PackagePrivate
<span class="nc" id="L72">	static final String COLUMN_NAME_MUNICIPALITY = Finals.constant(&quot;Gemeinde&quot;);</span>

	static {
		// Making sure that both Workbook Factories are registered to support XLS and
		// XLSX. Registering automatically might be a problem when creating a JAR with
		// all dependencies.
<span class="nc" id="L78">		WorkbookFactory.addProvider(new XSSFWorkbookFactory());</span>
<span class="nc" id="L79">		WorkbookFactory.addProvider(new HSSFWorkbookFactory());</span>
<span class="nc" id="L80">	}</span>

	public static List&lt;Budget&gt; read(final Path source) throws IOException, StringParseException {
<span class="nc" id="L83">		try (</span>
<span class="nc" id="L84">			InputStream inputStream = Files.newInputStream(source);</span>
<span class="nc" id="L85">			Workbook workbook = WorkbookFactory.create(inputStream)) {</span>
<span class="nc" id="L86">			final String fileName = Nullables.orElseThrow(source.getFileName()).toString();</span>
<span class="nc" id="L87">			return Budgets.of(new ExcelSheets(fileName, workbook));</span>
		}
	}

	public static void write(final List&lt;Budget&gt; budgets, final OutputStream outputStream) throws IOException {
<span class="nc" id="L92">		new ExcelFileWriter(budgets, outputStream).write();</span>
<span class="nc" id="L93">	}</span>


	private static class ExcelFileWriter {
		/**
		 * Width of the auto filter control in Excel, calculated using the difference of
		 * a cell without and with auto filter
		 */
		private static final int AUTO_FILTER_WIDTH = 563;
<span class="nc" id="L102">		private static final Map&lt;BudgetType, SimplifiedCellStyle&gt; SIMPLIFIED_CELL_STYLES = Maps.&lt;BudgetType, SimplifiedCellStyle&gt;builder().put(BudgetType.of(&quot;Plan&quot;), SimplifiedCellStyle.NORMAL).put(BudgetType.of(&quot;Ist&quot;), SimplifiedCellStyle.BOLD).unmodifiable();</span>
		/**
		 * Width of one character
		 */
		private static final int CHARACTER_WIDTH = 256;
		/**
		 * The maximum width of a column
		 */
		private static final int COLUMN_MAX_WIDTH = 255 * CHARACTER_WIDTH;
		private static final String DATA_FORMAT_CURRENCY = &quot;#,##0.00\\ \&quot;€\&quot;;[Red]\\-#,##0.00\\ \&quot;€\&quot;;\&quot;\&quot;&quot;;
		private static final String SHEET_NAME_ACCOUNTS = &quot;Konten&quot;;
		private static final String SHEET_NAME_PRODUCTS = &quot;Produkte&quot;;
		private static final String COLUMN_NAME_ACCOUNT = &quot;Konto&quot;;
		private static final String COLUMN_NAME_ACCOUNT_DESCRIPTION = &quot;Kontobeschreibung&quot;;
		private static final String COLUMN_NAME_DESCRIPTION = &quot;Beschreibung&quot;;
		private static final String COLUMN_NAME_PRODUCT = &quot;Produkt&quot;;
		private static final String COLUMN_NAME_PRODUCT_DESCRIPTION = &quot;Produktbeschreibung&quot;;
		private static final String COLUMN_NAME_SUM = &quot;Summieren&quot;;
		/**
		 * Excel data format for any number with any number of decimal places
		 */
<span class="nc" id="L123">		private static final ThreadLocal&lt;NumberFormat&gt; DECIMAL_FORMAT = ThreadLocal.withInitial(() -&gt; {</span>
<span class="nc" id="L124">			final DecimalFormat format = new DecimalFormat(&quot;0.#&quot;, DecimalFormatSymbols.getInstance(Locale.ROOT));</span>
<span class="nc" id="L125">			format.setMaximumFractionDigits(Integer.MAX_VALUE);</span>
<span class="nc" id="L126">			return format;</span>
		});

		private static void addBudgetsComment(final Cell cell, final Budget budget) {
<span class="nc" id="L130">			final StringBuilder comment = new StringBuilder();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">			for (final Entry&lt;BudgetReference, String&gt; entry : budget.getReferences().entrySet()) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">				if (comment.length() &gt; 0) {</span>
<span class="nc" id="L133">					comment.append('\n');</span>
				}
				//
<span class="nc" id="L136">				comment.append(entry.getKey().getDisplayValue()).append(&quot;: &quot;).append(entry.getValue());</span>
<span class="nc" id="L137">			}</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if (comment.length() &gt; 0) {</span>
<span class="nc" id="L139">				addComment(cell, comment.toString());</span>
			}
<span class="nc" id="L141">		}</span>

		@SuppressWarnings(&quot;checkstyle:MagicNumber&quot;)
		private static void addComment(final Cell cell, final String value) {
			@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;resource&quot;})
<span class="nc" id="L146">			final CreationHelper creationHelper = cell.getSheet().getWorkbook().getCreationHelper();</span>
<span class="nc" id="L147">			final ClientAnchor clientAnchor = creationHelper.createClientAnchor();</span>
<span class="nc" id="L148">			clientAnchor.setCol1(cell.getColumnIndex());</span>
<span class="nc" id="L149">			clientAnchor.setCol2(cell.getColumnIndex() + 3);</span>
<span class="nc" id="L150">			clientAnchor.setRow1(cell.getRow().getRowNum());</span>
<span class="nc" id="L151">			clientAnchor.setRow2(cell.getRow().getRowNum() + 5);</span>
<span class="nc" id="L152">			final Comment comment = cell.getSheet().createDrawingPatriarch().createCellComment(clientAnchor);</span>
<span class="nc" id="L153">			comment.setString(creationHelper.createRichTextString(value));</span>
<span class="nc" id="L154">			cell.setCellComment(comment);</span>
<span class="nc" id="L155">		}</span>

		/**
		 * Appends a row to {@code sheet} below the currently last row.
		 *
		 * @param sheet the sheet to modify
		 * @return the created row
		 */
		private static Row appendRow(final Sheet sheet) {
<span class="nc" id="L164">			return CellUtil.getRow(sheet.getLastRowNum() + 1, sheet);</span>
		}

		/**
		 * Creates a table with auto filter, default style and {@ode name}, spanning all
		 * curently available cells.
		 *
		 * @param sheet the sheet to modify
		 * @param name  the table name
		 * @return the created table
		 */
		private static XSSFTable createTable(final Sheet sheet, final String name) {
<span class="nc" id="L176">			final XSSFTable table = ((XSSFSheet) sheet).createTable(new AreaReference(new CellReference(0, 0), new CellReference(sheet.getLastRowNum(), CellUtil.getRow(0, sheet).getLastCellNum() - 1), SpreadsheetVersion.EXCEL2007));</span>
<span class="nc" id="L177">			table.setName(name);</span>
<span class="nc" id="L178">			table.setDisplayName(name);</span>
<span class="nc" id="L179">			table.setStyleName(&quot;TableStyleLight1&quot;);</span>
<span class="nc" id="L180">			table.getCTTable().addNewAutoFilter();</span>
<span class="nc" id="L181">			table.getCTTable().getTableStyleInfo().setShowRowStripes(true);</span>
<span class="nc" id="L182">			return table;</span>
		}

		private static SimplifiedCellStyle getSimplifiedCellStyle(final Budget budget) {
<span class="nc" id="L186">			return Nullables.orElse(SIMPLIFIED_CELL_STYLES.get(budget.getType()), SimplifiedCellStyle.ITALIC);</span>
		}

		/**
		 * Sets a numeric {@code value} for {@code cell}.
		 *
		 * &lt;p&gt;
		 * This method allows setting e.g. precise {@link java.math.BigDecimal} values,
		 * but does not permit infinite and {@code NaN} values.
		 *
		 * @param cell  the cell to modify
		 * @param value the value to set
		 */
		private static void setCellValue(final Cell cell, final Number value) {
<span class="nc" id="L200">			final CTCell ctCell = ((XSSFCell) cell).getCTCell();</span>
<span class="nc" id="L201">			ctCell.setT(STCellType.N);</span>
<span class="nc" id="L202">			ctCell.setV(DECIMAL_FORMAT.get().format(value));</span>
<span class="nc" id="L203">		}</span>

		private final List&lt;Budget&gt; budgets;
		private final OutputStream outputStream;
		private final Set&lt;String&gt; budgetColumnNamesUsed = new HashSet&lt;&gt;();
		private final Map&lt;Budget, String&gt; budgetColumnNames = new IdentityHashMap&lt;&gt;();
		/**
		 * Cache to simplify reusing {@link CellStyle} instances
		 */
		private final Map&lt;String, CellStyle&gt; cellStyleCache = new HashMap&lt;&gt;();

		@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;resource&quot;})
		private &lt;T&gt; Cell appendCell(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final Optional&lt;String&gt; dataFormat, final BiConsumer&lt;Cell, T&gt; setValue, final Optional&lt;T&gt; value) {
<span class="nc" id="L216">			final Cell cell = CellUtil.getCell(row, Math.max(0, row.getLastCellNum()));</span>
<span class="nc" id="L217">			getCellStyle(row.getSheet().getWorkbook(), simplifiedCellStyle, dataFormat).ifPresent(cell::setCellStyle);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">			if (value.isPresent()) {</span>
<span class="nc" id="L219">				setValue.accept(cell, value.get());</span>
			}
<span class="nc" id="L221">			return cell;</span>
		}

		private Cell appendBoolean(final Row row, final boolean value) {
<span class="nc" id="L225">			return appendCell(row, SimplifiedCellStyle.NORMAL, Optional.empty(), Cell::setCellValue, Optional.of(value));</span>
		}

		private Iterator&lt;CTTableColumn&gt; appendTotalsRow(final Row row, final CTTable table, final int emptyColumns) {
<span class="nc" id="L229">			table.setTotalsRowCount(1);</span>
<span class="nc" id="L230">			final Iterator&lt;CTTableColumn&gt; columns = table.getTableColumns().getTableColumnList().iterator();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">			for (int i = 0; i &lt; emptyColumns; i += 1) {</span>
<span class="nc" id="L232">				columns.next().setTotalsRowLabel(&quot;&quot;);</span>
<span class="nc" id="L233">				appendStrings(row, &quot;&quot;);</span>
			}
<span class="nc" id="L235">			return columns;</span>
		}

		private Cell appendFormula(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final String dataFormat, final String formula) {
<span class="nc" id="L239">			return appendCell(row, simplifiedCellStyle, Optional.of(dataFormat), Cell::setCellFormula, Optional.of(formula));</span>
		}

		private Cell appendNumber(final Row row, final OptionalInt value) {
<span class="nc" id="L243">			return appendCell(row, SimplifiedCellStyle.NORMAL, Optional.empty(), ExcelFileWriter::setCellValue, OptionalInts.boxed(value));</span>
		}

		private Cell appendNumber(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final String dataFormat, final Optional&lt;? extends Number&gt; value) {
<span class="nc" id="L247">			return appendCell(row, simplifiedCellStyle, Optional.of(dataFormat), ExcelFileWriter::setCellValue, value);</span>
		}

		private Cell appendString(final Row row, final String value) {
<span class="nc" id="L251">			return appendString(row, SimplifiedCellStyle.NORMAL, value);</span>
		}

		private Cell appendString(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final String value) {
<span class="nc" id="L255">			return appendCell(row, simplifiedCellStyle, Optional.empty(), Cell::setCellValue, Optional.of(value));</span>
		}

		private void appendStrings(final Row row, final String... values) {
<span class="nc bnc" id="L259" title="All 2 branches missed.">			for (final String value : values) {</span>
<span class="nc" id="L260">				appendString(row, value);</span>
			}
<span class="nc" id="L262">		}</span>

		private String getBudgetColumnName(final Budget budget) {
			// 1. Try to find a cached name
<span class="nc" id="L266">			final String cachedName = budgetColumnNames.get(budget);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">			if (cachedName != null) {</span>
<span class="nc" id="L268">				return cachedName;</span>
			}
			// 2. Create the straight-forward column name
<span class="nc" id="L271">			final String simpleName = String.format(&quot;%s %d&quot;, budget.getType().getName(), budget.getYear());</span>
<span class="nc" id="L272">			String columnName = simpleName;</span>
			// 3. Add a number in case of multiple columns with the same name
<span class="nc bnc" id="L274" title="All 2 branches missed.">			for (int count = 2; budgetColumnNamesUsed.contains(columnName); count += 1) {</span>
<span class="nc" id="L275">				columnName = String.format(&quot;%s (%d)&quot;, simpleName, count);</span>
			}
			// 4. Add to cache and return
<span class="nc" id="L278">			budgetColumnNamesUsed.add(columnName);</span>
<span class="nc" id="L279">			budgetColumnNames.put(budget, columnName);</span>
<span class="nc" id="L280">			return columnName;</span>
		}

		private Optional&lt;CellStyle&gt; getCellStyle(final Workbook workbook, final SimplifiedCellStyle simplifiedCellStyle, final Optional&lt;String&gt; dataFormat) {
<span class="nc bnc" id="L284" title="All 4 branches missed.">			if (simplifiedCellStyle == SimplifiedCellStyle.NORMAL &amp;&amp; !dataFormat.isPresent()) {</span>
<span class="nc" id="L285">				return Optional.empty();</span>
			}
<span class="nc" id="L287">			return Optional.of(cellStyleCache.computeIfAbsent(simplifiedCellStyle.name() + ';' + dataFormat.orElse(&quot;&quot;), key -&gt; {</span>
<span class="nc" id="L288">				final CellStyle cellStyle = workbook.createCellStyle();</span>
<span class="nc" id="L289">				dataFormat.ifPresent(format -&gt; cellStyle.setDataFormat(workbook.createDataFormat().getFormat(format)));</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">				if (simplifiedCellStyle != SimplifiedCellStyle.NORMAL) {</span>
<span class="nc" id="L291">					final Font font = workbook.createFont();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">					if (simplifiedCellStyle == SimplifiedCellStyle.BOLD) {</span>
<span class="nc" id="L293">						font.setBold(true);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">					} else if (simplifiedCellStyle == SimplifiedCellStyle.ITALIC) {</span>
<span class="nc" id="L295">						font.setItalic(true);</span>
					}
<span class="nc" id="L297">					cellStyle.setFont(font);</span>
				}
<span class="nc" id="L299">				return cellStyle;</span>
			}));
		}

		@PackagePrivate
		void write() throws IOException {
<span class="nc" id="L305">			try (XSSFWorkbook workbook = new XSSFWorkbook()) {</span>
<span class="nc" id="L306">				workbook.setCellFormulaValidation(false);</span>
<span class="nc" id="L307">				writeProducts(workbook.createSheet(SHEET_NAME_PRODUCTS));</span>
<span class="nc" id="L308">				writeAccounts(workbook.createSheet(SHEET_NAME_ACCOUNTS));</span>
				// Auto Size Columns
<span class="nc" id="L310">				workbook.sheetIterator().forEachRemaining(sheet -&gt; {</span>
<span class="nc" id="L311">					final int numberOfColumns = sheet.getRow(0).getLastCellNum();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">					for (int columnIndex = 0; columnIndex &lt; numberOfColumns; columnIndex += 1) {</span>
<span class="nc" id="L313">						sheet.autoSizeColumn(columnIndex);</span>
						// Add the width of the auto filter
<span class="nc" id="L315">						final double widthOfHeader = SheetUtil.getColumnWidth(sheet, columnIndex, false, 0, 0);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">						if (widthOfHeader != -1) {</span>
<span class="nc" id="L317">							final int intWidth = (int) Math.round(Math.min(CHARACTER_WIDTH * widthOfHeader + AUTO_FILTER_WIDTH, COLUMN_MAX_WIDTH));</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">							if (intWidth &gt; sheet.getColumnWidth(columnIndex)) {</span>
<span class="nc" id="L319">								sheet.setColumnWidth(columnIndex, intWidth);</span>
							}
						}
					}
<span class="nc" id="L323">				});</span>
<span class="nc" id="L324">				workbook.write(outputStream);</span>
			}
<span class="nc" id="L326">		}</span>

		@SuppressWarnings(&quot;checkstyle:MagicNumber&quot;)
		private void writeProducts(final XSSFSheet sheet) {
<span class="nc" id="L330">			final Set&lt;Product&gt; products = Budgets.getProducts(budgets);</span>
<span class="nc" id="L331">			appendProducts(sheet, products);</span>
<span class="nc" id="L332">			appendProductBudgets(sheet, products);</span>
			// Table
<span class="nc" id="L334">			sheet.createFreezePane(3, 0);</span>
<span class="nc" id="L335">			final XSSFTable table = createTable(sheet, SHEET_NAME_PRODUCTS);</span>
			// Totals Row
<span class="nc" id="L337">			table.setDataRowCount(table.getDataRowCount() + 1);</span>
<span class="nc" id="L338">			appendProductsTotalsRow(appendRow(sheet), table.getCTTable());</span>
<span class="nc" id="L339">		}</span>

		private void appendProducts(final Sheet sheet, final Set&lt;Product&gt; products) {
			// Headers
<span class="nc" id="L343">			appendStrings(appendRow(sheet), COLUMN_NAME_MUNICIPALITY, COLUMN_NAME_PRODUCT, COLUMN_NAME_DESCRIPTION, COLUMN_NAME_SUM);</span>
			// Values
<span class="nc bnc" id="L345" title="All 2 branches missed.">			for (final Product product : products) {</span>
<span class="nc" id="L346">				final Row row = appendRow(sheet);</span>
<span class="nc" id="L347">				appendNumber(row, OptionalInt.of(product.getMunicipality().getId()));</span>
<span class="nc" id="L348">				appendNumber(row, OptionalInt.of(product.getId()));</span>
<span class="nc" id="L349">				appendString(row, product.getDescription());</span>
<span class="nc" id="L350">				appendBoolean(row, true);</span>
<span class="nc" id="L351">			}</span>
<span class="nc" id="L352">		}</span>

		private void appendProductBudgets(final XSSFSheet sheet, final Set&lt;Product&gt; products) {
<span class="nc bnc" id="L355" title="All 2 branches missed.">			for (final Budget budget : budgets) {</span>
				// Header
<span class="nc" id="L357">				final Cell headerCell = appendString(sheet.getRow(0), getSimplifiedCellStyle(budget), getBudgetColumnName(budget));</span>
<span class="nc" id="L358">				addBudgetsComment(headerCell, budget);</span>
				// Balances
<span class="nc" id="L360">				int rowIndex = 1;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">				for (int i = products.size(); i &gt; 0; i -= 1) {</span>
<span class="nc" id="L362">					appendFormula(sheet.getRow(rowIndex), getSimplifiedCellStyle(budget), DATA_FORMAT_CURRENCY, String.format(&quot;SUMIFS(%1$s[%7$s], %1$s[%3$s], %2$s[[#This Row],[%3$s]], %1$s[%4$s], %2$s[[#This Row],[%5$s]], %1$s[%6$s], TRUE)&quot;, SHEET_NAME_ACCOUNTS,  // 1</span>
					SHEET_NAME_PRODUCTS,  // 2
					COLUMN_NAME_PRODUCT,  // 3
					COLUMN_NAME_PRODUCT_DESCRIPTION,  // 4
					COLUMN_NAME_DESCRIPTION,  // 5
					COLUMN_NAME_SUM,  // 6
<span class="nc" id="L368">					getBudgetColumnName(budget))); // 7</span>
<span class="nc" id="L369">					rowIndex += 1;</span>
				}
<span class="nc" id="L371">			}</span>
<span class="nc" id="L372">		}</span>

		private void appendProductsTotalsRow(final Row row, final CTTable table) {
<span class="nc" id="L375">			final Iterator&lt;CTTableColumn&gt; columns = appendTotalsRow(row, table, 4);</span>
<span class="nc" id="L376">			appendSumsForBudgets(row, columns);</span>
<span class="nc" id="L377">		}</span>

		private void writeAccounts(final XSSFSheet sheet) {
<span class="nc" id="L380">			final Set&lt;Account&gt; accounts = Budgets.getAccounts(budgets);</span>
<span class="nc" id="L381">			appendAccounts(sheet, accounts);</span>
<span class="nc" id="L382">			appendAccountBudgets(sheet, accounts);</span>
			// Table
<span class="nc" id="L384">			final XSSFTable table = createTable(sheet, SHEET_NAME_ACCOUNTS);</span>
			// Totals Row
<span class="nc" id="L386">			table.setDataRowCount(table.getDataRowCount() + 1);</span>
<span class="nc" id="L387">			appendAccountsTotalsRow(appendRow(sheet), table.getCTTable());</span>
<span class="nc" id="L388">		}</span>

		private void appendAccounts(final Sheet sheet, final Set&lt;Account&gt; accounts) {
			// Headers
<span class="nc" id="L392">			final Row headerRow = appendRow(sheet);</span>
<span class="nc" id="L393">			appendStrings(headerRow, COLUMN_NAME_MUNICIPALITY, COLUMN_NAME_PRODUCT, COLUMN_NAME_PRODUCT_DESCRIPTION, COLUMN_NAME_ACCOUNT, COLUMN_NAME_ACCOUNT_DESCRIPTION, COLUMN_NAME_SUM);</span>
<span class="nc" id="L394">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.COLUMN_NAME_MUNICIPALITY).getColumnIndex(), true);</span>
<span class="nc" id="L395">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.COLUMN_NAME_PRODUCT_ID).getColumnIndex(), true);</span>
<span class="nc" id="L396">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.COLUMN_NAME_PRODUCT_DESCRIPTION).getColumnIndex(), true);</span>
<span class="nc" id="L397">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.COLUMN_NAME_ACCOUNT).getColumnIndex(), true);</span>
			// Values
<span class="nc bnc" id="L399" title="All 2 branches missed.">			for (final Account account : accounts) {</span>
<span class="nc" id="L400">				final Row row = appendRow(sheet);</span>
<span class="nc" id="L401">				appendNumber(row, OptionalInt.of(account.getProduct().getMunicipality().getId()));</span>
<span class="nc" id="L402">				appendNumber(row, OptionalInt.of(account.getProduct().getId()));</span>
<span class="nc" id="L403">				appendString(row, account.getProduct().getDescription());</span>
<span class="nc" id="L404">				appendNumber(row, OptionalInt.of(account.getId()));</span>
<span class="nc" id="L405">				appendString(row, account.getDescription());</span>
<span class="nc" id="L406">				appendBoolean(row, true);</span>
<span class="nc" id="L407">				appendNumber(row, OptionalInt.of(account.getProduct().getMunicipality().getId()));</span>
<span class="nc" id="L408">				appendNumber(row, OptionalInt.of(account.getProduct().getId()));</span>
<span class="nc" id="L409">				appendString(row, account.getProduct().getDescription());</span>
<span class="nc" id="L410">				appendString(row, String.format(&quot;%d %s&quot;, account.getId(), account.getDescription()));</span>
<span class="nc" id="L411">			}</span>
<span class="nc" id="L412">		}</span>

		private void appendAccountBudgets(final XSSFSheet sheet, final Set&lt;Account&gt; accounts) {
<span class="nc bnc" id="L415" title="All 2 branches missed.">			for (final Budget budget : budgets) {</span>
				// Header
<span class="nc" id="L417">				final Cell headerCell = appendString(sheet.getRow(0), getSimplifiedCellStyle(budget), getBudgetColumnName(budget));</span>
<span class="nc" id="L418">				addBudgetsComment(headerCell, budget);</span>
				// Balances
<span class="nc" id="L420">				int rowIndex = 1;</span>
<span class="nc" id="L421">				final Map&lt;Account, Balance&gt; balances = budget.getBalances();</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">				for (final Account account : accounts) {</span>
<span class="nc" id="L423">					final Optional&lt;Balance&gt; balance = Optional.ofNullable(balances.get(account));</span>
<span class="nc" id="L424">					appendNumber(sheet.getRow(rowIndex), getSimplifiedCellStyle(budget), DATA_FORMAT_CURRENCY, balance.map(Balance::getValue));</span>
<span class="nc" id="L425">					rowIndex += 1;</span>
<span class="nc" id="L426">				}</span>
<span class="nc" id="L427">			}</span>
<span class="nc" id="L428">		}</span>

		private void appendAccountsTotalsRow(final Row row, final CTTable table) {
<span class="nc" id="L431">			final Iterator&lt;CTTableColumn&gt; columns = appendTotalsRow(row, table, 10);</span>
<span class="nc" id="L432">			appendSumsForBudgets(row, columns);</span>
<span class="nc" id="L433">		}</span>

		private void appendSumsForBudgets(final Row row, final Iterator&lt;CTTableColumn&gt; columnsIterator) {
<span class="nc bnc" id="L436" title="All 2 branches missed.">			for (final Budget budget : budgets) {</span>
<span class="nc" id="L437">				columnsIterator.next().setTotalsRowFunction(STTotalsRowFunction.CUSTOM);</span>
<span class="nc" id="L438">				appendFormula(row, getSimplifiedCellStyle(budget), DATA_FORMAT_CURRENCY, String.format(&quot;SUMIFS(%1$s[%3$s], %1$s[%2$s], TRUE)&quot;, SHEET_NAME_PRODUCTS, COLUMN_NAME_SUM, getBudgetColumnName(budget)));</span>
<span class="nc" id="L439">			}</span>
<span class="nc" id="L440">		}</span>

		@java.lang.SuppressWarnings(&quot;all&quot;)
		@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
		@lombok.Generated
		ExcelFileWriter(final List&lt;Budget&gt; budgets, final OutputStream outputStream) {
			this.budgets = budgets;
			this.outputStream = outputStream;
		}
	}


<span class="nc" id="L452">	@SuppressWarnings(&quot;PMD.UnnecessaryModifier&quot;)</span>
	private static enum SimplifiedCellStyle {
<span class="nc" id="L454">		BOLD, ITALIC, NORMAL;</span>
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	private ExcelFiles() {
		throw new java.lang.UnsupportedOperationException(&quot;This is a utility class and cannot be instantiated&quot;);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>