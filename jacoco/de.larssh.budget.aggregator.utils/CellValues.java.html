<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CellValues.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Budget Aggregator</a> &gt; <a href="index.source.html" class="el_package">de.larssh.budget.aggregator.utils</a> &gt; <span class="el_source">CellValues.java</span></div><h1>CellValues.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Jun 09 22:22:59 UTC 2025
package de.larssh.budget.aggregator.utils;

import java.lang.reflect.Constructor;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.Optional;
import java.util.WeakHashMap;
import org.apache.poi.ss.formula.eval.ErrorEval;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellType;
import org.apache.poi.ss.usermodel.CellValue;
import org.apache.poi.ss.usermodel.DateUtil;
import org.apache.poi.ss.usermodel.FormulaError;
import org.apache.poi.ss.usermodel.FormulaEvaluator;
import org.apache.poi.ss.usermodel.Workbook;
import edu.umd.cs.findbugs.annotations.Nullable;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

public final class CellValues {
	@SuppressWarnings({&quot;checkstyle:ConstantName&quot;, &quot;PMD.FieldNamingConventions&quot;})
<span class="nc" id="L23">	public static final CellValue _NONE = create(CellType._NONE, 0, false, null, 0);</span>
<span class="nc" id="L24">	public static final CellValue BLANK = create(CellType.BLANK, 0, false, null, 0);</span>
	private static final String DATE_STRING_VALUE = &quot;__DATE__&quot;;
<span class="nc" id="L26">	private static final Map&lt;Workbook, FormulaEvaluator&gt; FORMULA_EVALUATORS = new WeakHashMap&lt;&gt;();</span>

	@SuppressWarnings({&quot;java:S112&quot;, &quot;java:S3011&quot;, &quot;PMD.AvoidAccessibilityAlteration&quot;, &quot;PMD.AvoidThrowingRawExceptionTypes&quot;})
	@SuppressFBWarnings(value = {&quot;EXS_EXCEPTION_SOFTENING_NO_CONSTRAINTS&quot;, &quot;RFI_SET_ACCESSIBLE&quot;, &quot;WEM_WEAK_EXCEPTION_MESSAGING&quot;}, justification = &quot;correct; not nice but required; no relevant information available here&quot;)
	private static CellValue create(final CellType cellType, final double numberValue, final boolean booleanValue, @Nullable final String textValue, final int errorCode) {
		try {
<span class="nc" id="L32">			final Constructor&lt;CellValue&gt; constructor = CellValue.class.getDeclaredConstructor(CellType.class, double.class, boolean.class, String.class, int.class);</span>
<span class="nc" id="L33">			constructor.setAccessible(true);</span>
<span class="nc" id="L34">			return constructor.newInstance(cellType, numberValue, booleanValue, textValue, errorCode);</span>
<span class="nc" id="L35">		} catch (final ReflectiveOperationException e) {</span>
<span class="nc" id="L36">			throw new RuntimeException(&quot;Failed creating CellValue instance&quot;, e);</span>
		}
	}

	@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;PMD.CyclomaticComplexity&quot;, &quot;PMD.ExhaustiveSwitchHasDefault&quot;, &quot;resource&quot;})
	public static CellValue create(@Nullable final Cell cell, final boolean evaluateFormula) {
<span class="nc bnc" id="L42" title="All 2 branches missed.">		if (cell == null) {</span>
<span class="nc" id="L43">			return new CellValue(&quot;&quot;);</span>
		}
<span class="nc bnc" id="L45" title="All 7 branches missed.">		switch (cell.getCellType()) {</span>
		case BOOLEAN: 
<span class="nc bnc" id="L47" title="All 2 branches missed.">			return cell.getBooleanCellValue() ? CellValue.TRUE : CellValue.FALSE;</span>
		case BLANK: 
<span class="nc" id="L49">			return new CellValue(&quot;&quot;);</span>
		case ERROR: 
<span class="nc" id="L51">			return CellValue.getError(cell.getErrorCellValue());</span>
		case FORMULA: 
<span class="nc bnc" id="L53" title="All 2 branches missed.">			return evaluateFormula ? evaluateFormula(cell) : create(CellType.FORMULA, 0, false, cell.getCellFormula(), 0);</span>
		case NUMERIC: 
<span class="nc bnc" id="L55" title="All 2 branches missed.">			return DateUtil.isCellDateFormatted(cell) ? create(CellType.NUMERIC, cell.getNumericCellValue(), Workbooks.isUsing1904DateWindowing(cell.getSheet().getWorkbook()), DATE_STRING_VALUE, 0) : new CellValue(cell.getNumericCellValue());</span>
		case STRING: 
<span class="nc" id="L57">			return new CellValue(cell.getStringCellValue());</span>
		case _NONE: 
		default: 
<span class="nc" id="L60">			return CellValue.getError(FormulaError.FUNCTION_NOT_IMPLEMENTED.getLongCode());</span>
		}
	}

	@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;resource&quot;})
	private static CellValue evaluateFormula(final Cell cell) {
<span class="nc" id="L66">		return FORMULA_EVALUATORS.computeIfAbsent(cell.getSheet().getWorkbook(), workbook -&gt; workbook.getCreationHelper().createFormulaEvaluator()).evaluate(cell);</span>
	}

	@SuppressFBWarnings(value = &quot;OPM_OVERLY_PERMISSIVE_METHOD&quot;, justification = &quot;API method&quot;)
	public static Optional&lt;LocalDateTime&gt; getLocalDateTime(final CellValue value) {
<span class="nc bnc" id="L71" title="All 2 branches missed.">		return isDate(value) ? Optional.of(DateUtil.getLocalDateTime(value.getNumberValue(), value.getBooleanValue())) : Optional.empty();</span>
	}

	@SuppressWarnings(&quot;PMD.ExhaustiveSwitchHasDefault&quot;)
	public static String getAsString(final CellValue value) {
<span class="nc bnc" id="L76" title="All 6 branches missed.">		switch (value.getCellType()) {</span>
		case BOOLEAN: 
<span class="nc bnc" id="L78" title="All 2 branches missed.">			return value.getBooleanValue() ? &quot;TRUE&quot; : &quot;FALSE&quot;;</span>
		case BLANK: 
<span class="nc" id="L80">			return &quot;&quot;;</span>
		case ERROR: 
<span class="nc" id="L82">			return ErrorEval.getText(value.getErrorValue());</span>
		case NUMERIC: 
<span class="nc" id="L84">			return getLocalDateTime(value).map(localDateTime -&gt; localDateTime.format(DateTimeFormatter.ISO_LOCAL_TIME)).orElseGet(() -&gt; {</span>
<span class="nc" id="L85">				final String numericValue = Double.toString(value.getNumberValue());</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">				return numericValue.endsWith(&quot;.0&quot;) ? numericValue.substring(0, numericValue.length() - 2) : numericValue;</span>
			});
		case STRING: 
		case FORMULA: 
<span class="nc" id="L90">			return value.getStringValue();</span>
		case _NONE: 
		default: 
<span class="nc" id="L93">			return &quot;Unexpected Cell Type: &quot; + value.getCellType();</span>
		}
	}

	@SuppressFBWarnings(value = &quot;OPM_OVERLY_PERMISSIVE_METHOD&quot;, justification = &quot;API method&quot;)
	public static boolean isDate(final CellValue value) {
<span class="nc bnc" id="L99" title="All 4 branches missed.">		return value.getCellType() == CellType.NUMERIC &amp;&amp; DATE_STRING_VALUE.equals(value.getStringValue());</span>
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	private CellValues() {
		throw new java.lang.UnsupportedOperationException(&quot;This is a utility class and cannot be instantiated&quot;);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>