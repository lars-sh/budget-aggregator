<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExcelFiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Budget Aggregator</a> &gt; <a href="index.source.html" class="el_package">de.larssh.budget.aggregator.file</a> &gt; <span class="el_source">ExcelFiles.java</span></div><h1>ExcelFiles.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Jun 09 22:22:59 UTC 2025
package de.larssh.budget.aggregator.file;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.text.DecimalFormat;
import java.text.DecimalFormatSymbols;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.IdentityHashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.Set;
import java.util.function.BiConsumer;
import org.apache.poi.hssf.usermodel.HSSFWorkbookFactory;
import org.apache.poi.ss.SpreadsheetVersion;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.ClientAnchor;
import org.apache.poi.ss.usermodel.Comment;
import org.apache.poi.ss.usermodel.CreationHelper;
import org.apache.poi.ss.usermodel.Font;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import org.apache.poi.ss.util.AreaReference;
import org.apache.poi.ss.util.CellReference;
import org.apache.poi.ss.util.CellUtil;
import org.apache.poi.ss.util.SheetUtil;
import org.apache.poi.xssf.usermodel.XSSFCell;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFTable;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbookFactory;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.CTCell;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.CTTable;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.CTTableColumn;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.STCellType;
import org.openxmlformats.schemas.spreadsheetml.x2006.main.STTotalsRowFunction;
import de.larssh.budget.aggregator.data.Account;
import de.larssh.budget.aggregator.data.Balance;
import de.larssh.budget.aggregator.data.Budget;
import de.larssh.budget.aggregator.data.BudgetReference;
import de.larssh.budget.aggregator.data.BudgetType;
import de.larssh.budget.aggregator.data.Budgets;
import de.larssh.budget.aggregator.data.Product;
import de.larssh.budget.aggregator.utils.CellValues;
import de.larssh.utils.Nullables;
import de.larssh.utils.OptionalInts;
import de.larssh.utils.annotations.PackagePrivate;
import de.larssh.utils.collection.Maps;
import de.larssh.utils.text.Csv;
import de.larssh.utils.text.StringParseException;

@SuppressWarnings({&quot;PMD.CouplingBetweenObjects&quot;, &quot;PMD.ExcessiveImports&quot;})
public final class ExcelFiles {
	static {
		// Making sure that both Workbook Factories are registered to support XLS and
		// XLSX. Registering automatically might be a problem when creating a JAR with
		// all dependencies.
<span class="nc" id="L72">		WorkbookFactory.addProvider(new XSSFWorkbookFactory());</span>
<span class="nc" id="L73">		WorkbookFactory.addProvider(new HSSFWorkbookFactory());</span>
<span class="nc" id="L74">	}</span>

	public static List&lt;Budget&gt; read(final Path source) throws IOException, StringParseException {
<span class="nc" id="L77">		final List&lt;Budget&gt; budgets = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L78">		try (</span>
<span class="nc" id="L79">			InputStream inputStream = Files.newInputStream(source);</span>
<span class="nc" id="L80">			Workbook workbook = WorkbookFactory.create(inputStream)) {</span>
<span class="nc" id="L81">			final int numberOfSheets = workbook.getNumberOfSheets();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">			for (int sheetIndex = 0; sheetIndex &lt; numberOfSheets; sheetIndex += 1) {</span>
<span class="nc" id="L83">				final Sheet sheet = workbook.getSheetAt(sheetIndex);</span>
<span class="nc" id="L84">				final Set&lt;Budget&gt; sheetBudgets = Budget.of(readSheet(sheet));</span>
<span class="nc" id="L85">				Budgets.setReference(sheetBudgets, BudgetReference.FILE_NAME, Nullables.orElseThrow(source.getFileName()).toString());</span>
<span class="nc" id="L86">				Budgets.setReference(sheetBudgets, BudgetReference.SHEET, sheet.getSheetName());</span>
<span class="nc" id="L87">				budgets.addAll(sheetBudgets);</span>
			}
		}
<span class="nc" id="L90">		return budgets;</span>
	}

	@SuppressWarnings(&quot;PMD.LooseCoupling&quot;)
	private static Csv readSheet(final Sheet sheet) {
<span class="nc" id="L95">		final int lastRowIndex = sheet.getLastRowNum();</span>
<span class="nc" id="L96">		final int firstRowIndex = sheet.getFirstRowNum();</span>
<span class="nc" id="L97">		final List&lt;List&lt;String&gt;&gt; data = new ArrayList&lt;&gt;(lastRowIndex - firstRowIndex + 1);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		for (int rowIndex = firstRowIndex; rowIndex &lt;= lastRowIndex; rowIndex += 1) {</span>
<span class="nc" id="L99">			data.add(readRow(sheet.getRow(rowIndex)));</span>
		}
<span class="nc" id="L101">		return new Csv(data);</span>
	}

	private static List&lt;String&gt; readRow(final Row row) {
<span class="nc" id="L105">		final int lastCellIndex = row.getLastCellNum();</span>
<span class="nc" id="L106">		final int firstCellIndex = row.getFirstCellNum();</span>
<span class="nc" id="L107">		final List&lt;String&gt; cells = new ArrayList&lt;&gt;(lastCellIndex - firstCellIndex + 1);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		for (int cellIndex = firstCellIndex; cellIndex &lt;= lastCellIndex; cellIndex += 1) {</span>
<span class="nc" id="L109">			cells.add(CellValues.getAsString(CellValues.create(row.getCell(cellIndex), true)));</span>
		}
<span class="nc" id="L111">		return cells;</span>
	}

	public static void write(final List&lt;Budget&gt; budgets, final OutputStream outputStream) throws IOException {
<span class="nc" id="L115">		new ExcelFileWriter(budgets, outputStream).write();</span>
<span class="nc" id="L116">	}</span>


	private static class ExcelFileWriter {
		/**
		 * Width of the auto filter control in Excel, calculated using the difference of
		 * a cell without and with auto filter
		 */
		private static final int AUTO_FILTER_WIDTH = 563;
<span class="nc" id="L125">		private static final Map&lt;BudgetType, SimplifiedCellStyle&gt; SIMPLIFIED_CELL_STYLES = Maps.&lt;BudgetType, SimplifiedCellStyle&gt;builder().put(BudgetType.of(&quot;Plan&quot;), SimplifiedCellStyle.NORMAL).put(BudgetType.of(&quot;Ist&quot;), SimplifiedCellStyle.BOLD).unmodifiable();</span>
		/**
		 * Width of one character
		 */
		private static final int CHARACTER_WIDTH = 256;
		/**
		 * The maximum width of a column
		 */
		private static final int COLUMN_MAX_WIDTH = 255 * CHARACTER_WIDTH;
		private static final String DATA_FORMAT_CURRENCY = &quot;#,##0.00\\ \&quot;€\&quot;;[Red]\\-#,##0.00\\ \&quot;€\&quot;&quot;;
		private static final String SHEET_NAME_ACCOUNTS = &quot;Konten&quot;;
		private static final String SHEET_NAME_BALANCES = &quot;Produkte&quot;;
		private static final String COLUMN_NAME_ACCOUNT = &quot;Konto&quot;;
		private static final String COLUMN_NAME_ACCOUNT_DESCRIPTION = &quot;Kontobeschreibung&quot;;
		private static final String COLUMN_NAME_BALANCE = &quot;Produkt&quot;;
		private static final String COLUMN_NAME_BALANCE_DESCRIPTION = &quot;Produktbeschreibung&quot;;
		private static final String COLUMN_NAME_COMMUNITY = &quot;Gemeinde&quot;;
		private static final String COLUMN_NAME_DESCRIPTION = &quot;Beschreibung&quot;;
		private static final String COLUMN_NAME_SUM = &quot;Summieren&quot;;
		/**
		 * Excel data format for any number with any number of decimal places
		 */
<span class="nc" id="L147">		private static final ThreadLocal&lt;NumberFormat&gt; DECIMAL_FORMAT = ThreadLocal.withInitial(() -&gt; {</span>
<span class="nc" id="L148">			final DecimalFormat format = new DecimalFormat(&quot;0.#&quot;, DecimalFormatSymbols.getInstance(Locale.ROOT));</span>
<span class="nc" id="L149">			format.setMaximumFractionDigits(Integer.MAX_VALUE);</span>
<span class="nc" id="L150">			return format;</span>
		});

		private static void addBudgetsComment(final Cell cell, final Budget budget) {
<span class="nc" id="L154">			final StringBuilder comment = new StringBuilder();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">			for (final Entry&lt;BudgetReference, String&gt; entry : budget.getReferences().entrySet()) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">				if (comment.length() &gt; 0) {</span>
<span class="nc" id="L157">					comment.append('\n');</span>
				}
				//
<span class="nc" id="L160">				comment.append(entry.getKey().getDisplayValue()).append(&quot;: &quot;).append(entry.getValue());</span>
<span class="nc" id="L161">			}</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if (comment.length() &gt; 0) {</span>
<span class="nc" id="L163">				addComment(cell, comment.toString());</span>
			}
<span class="nc" id="L165">		}</span>

		@SuppressWarnings(&quot;checkstyle:MagicNumber&quot;)
		private static void addComment(final Cell cell, final String value) {
			@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;resource&quot;})
<span class="nc" id="L170">			final CreationHelper creationHelper = cell.getSheet().getWorkbook().getCreationHelper();</span>
<span class="nc" id="L171">			final ClientAnchor clientAnchor = creationHelper.createClientAnchor();</span>
<span class="nc" id="L172">			clientAnchor.setCol1(cell.getColumnIndex());</span>
<span class="nc" id="L173">			clientAnchor.setCol2(cell.getColumnIndex() + 3);</span>
<span class="nc" id="L174">			clientAnchor.setRow1(cell.getRow().getRowNum());</span>
<span class="nc" id="L175">			clientAnchor.setRow2(cell.getRow().getRowNum() + 5);</span>
<span class="nc" id="L176">			final Comment comment = cell.getSheet().createDrawingPatriarch().createCellComment(clientAnchor);</span>
<span class="nc" id="L177">			comment.setString(creationHelper.createRichTextString(value));</span>
<span class="nc" id="L178">			cell.setCellComment(comment);</span>
<span class="nc" id="L179">		}</span>

		/**
		 * Appends a row to {@code sheet} below the currently last row.
		 *
		 * @param sheet the sheet to modify
		 * @return the created row
		 */
		private static Row appendRow(final Sheet sheet) {
<span class="nc" id="L188">			return CellUtil.getRow(sheet.getLastRowNum() + 1, sheet);</span>
		}

		/**
		 * Creates a table with auto filter, default style and {@ode name}, spanning all
		 * curently available cells.
		 *
		 * @param sheet the sheet to modify
		 * @param name  the table name
		 * @return the created table
		 */
		private static XSSFTable createTable(final Sheet sheet, final String name) {
<span class="nc" id="L200">			final XSSFTable table = ((XSSFSheet) sheet).createTable(new AreaReference(new CellReference(0, 0), new CellReference(sheet.getLastRowNum(), CellUtil.getRow(0, sheet).getLastCellNum() - 1), SpreadsheetVersion.EXCEL2007));</span>
<span class="nc" id="L201">			table.setName(name);</span>
<span class="nc" id="L202">			table.setDisplayName(name);</span>
<span class="nc" id="L203">			table.setStyleName(&quot;TableStyleLight1&quot;);</span>
<span class="nc" id="L204">			table.getCTTable().addNewAutoFilter();</span>
<span class="nc" id="L205">			return table;</span>
		}

		private static SimplifiedCellStyle getSimplifiedCellStyle(final Budget budget) {
<span class="nc" id="L209">			return Nullables.orElse(SIMPLIFIED_CELL_STYLES.get(budget.getType()), SimplifiedCellStyle.ITALIC);</span>
		}

		/**
		 * Sets a numeric {@code value} for {@code cell}.
		 *
		 * &lt;p&gt;
		 * This method allows setting e.g. precise {@link java.math.BigDecimal} values,
		 * but does not permit infinite and {@code NaN} values.
		 *
		 * @param cell  the cell to modify
		 * @param value the value to set
		 */
		private static void setCellValue(final Cell cell, final Number value) {
<span class="nc" id="L223">			final CTCell ctCell = ((XSSFCell) cell).getCTCell();</span>
<span class="nc" id="L224">			ctCell.setT(STCellType.N);</span>
<span class="nc" id="L225">			ctCell.setV(DECIMAL_FORMAT.get().format(value));</span>
<span class="nc" id="L226">		}</span>

		private final List&lt;Budget&gt; budgets;
		private final OutputStream outputStream;
		private final Set&lt;String&gt; budgetColumnNamesUsed = new HashSet&lt;&gt;();
		private final Map&lt;Budget, String&gt; budgetColumnNames = new IdentityHashMap&lt;&gt;();
		/**
		 * Cache to simplify reusing {@link CellStyle} instances
		 */
		private final Map&lt;String, CellStyle&gt; cellStyleCache = new HashMap&lt;&gt;();

		@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;resource&quot;})
		private &lt;T&gt; Cell appendCell(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final Optional&lt;String&gt; dataFormat, final BiConsumer&lt;Cell, T&gt; setValue, final Optional&lt;T&gt; value) {
<span class="nc" id="L239">			final Cell cell = CellUtil.getCell(row, Math.max(0, row.getLastCellNum()));</span>
<span class="nc" id="L240">			getCellStyle(row.getSheet().getWorkbook(), simplifiedCellStyle, dataFormat).ifPresent(cell::setCellStyle);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			if (value.isPresent()) {</span>
<span class="nc" id="L242">				setValue.accept(cell, value.get());</span>
			}
<span class="nc" id="L244">			return cell;</span>
		}

		private Cell appendBoolean(final Row row, final boolean value) {
<span class="nc" id="L248">			return appendCell(row, SimplifiedCellStyle.NORMAL, Optional.empty(), Cell::setCellValue, Optional.of(value));</span>
		}

		private Iterator&lt;CTTableColumn&gt; appendTotalsRow(final Row row, final CTTable table, final int emptyColumns) {
<span class="nc" id="L252">			table.setTotalsRowCount(1);</span>
<span class="nc" id="L253">			final Iterator&lt;CTTableColumn&gt; columns = table.getTableColumns().getTableColumnList().iterator();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			for (int i = 0; i &lt; emptyColumns; i += 1) {</span>
<span class="nc" id="L255">				columns.next().setTotalsRowLabel(&quot;&quot;);</span>
<span class="nc" id="L256">				appendStrings(row, &quot;&quot;);</span>
			}
<span class="nc" id="L258">			return columns;</span>
		}

		private Cell appendFormula(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final String dataFormat, final String formula) {
<span class="nc" id="L262">			return appendCell(row, simplifiedCellStyle, Optional.of(dataFormat), Cell::setCellFormula, Optional.of(formula));</span>
		}

		private Cell appendNumber(final Row row, final OptionalInt value) {
<span class="nc" id="L266">			return appendCell(row, SimplifiedCellStyle.NORMAL, Optional.empty(), ExcelFileWriter::setCellValue, OptionalInts.boxed(value));</span>
		}

		private Cell appendNumber(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final String dataFormat, final Optional&lt;? extends Number&gt; value) {
<span class="nc" id="L270">			return appendCell(row, simplifiedCellStyle, Optional.of(dataFormat), ExcelFileWriter::setCellValue, value);</span>
		}

		private Cell appendString(final Row row, final String value) {
<span class="nc" id="L274">			return appendString(row, SimplifiedCellStyle.NORMAL, value);</span>
		}

		private Cell appendString(final Row row, final SimplifiedCellStyle simplifiedCellStyle, final String value) {
<span class="nc" id="L278">			return appendCell(row, simplifiedCellStyle, Optional.empty(), Cell::setCellValue, Optional.of(value));</span>
		}

		private void appendStrings(final Row row, final String... values) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">			for (final String value : values) {</span>
<span class="nc" id="L283">				appendString(row, value);</span>
			}
<span class="nc" id="L285">		}</span>

		private String getBudgetColumnName(final Budget budget) {
			// 1. Try to find a cached name
<span class="nc" id="L289">			final String cachedName = budgetColumnNames.get(budget);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			if (cachedName != null) {</span>
<span class="nc" id="L291">				return cachedName;</span>
			}
			// 2. Create the straight-forward column name
<span class="nc" id="L294">			final String simpleName = String.format(&quot;%s %d&quot;, budget.getType().getName(), budget.getYear());</span>
<span class="nc" id="L295">			String columnName = simpleName;</span>
			// 3. Add a number in case of multiple columns with the same name
<span class="nc bnc" id="L297" title="All 2 branches missed.">			for (int count = 2; budgetColumnNamesUsed.contains(columnName); count += 1) {</span>
<span class="nc" id="L298">				columnName = String.format(&quot;%s (%d)&quot;, simpleName, count);</span>
			}
			// 4. Add to cache and return
<span class="nc" id="L301">			budgetColumnNamesUsed.add(columnName);</span>
<span class="nc" id="L302">			budgetColumnNames.put(budget, columnName);</span>
<span class="nc" id="L303">			return columnName;</span>
		}

		private Optional&lt;CellStyle&gt; getCellStyle(final Workbook workbook, final SimplifiedCellStyle simplifiedCellStyle, final Optional&lt;String&gt; dataFormat) {
<span class="nc bnc" id="L307" title="All 4 branches missed.">			if (simplifiedCellStyle == SimplifiedCellStyle.NORMAL &amp;&amp; !dataFormat.isPresent()) {</span>
<span class="nc" id="L308">				return Optional.empty();</span>
			}
<span class="nc" id="L310">			return Optional.of(cellStyleCache.computeIfAbsent(simplifiedCellStyle.name() + ';' + dataFormat.orElse(&quot;&quot;), key -&gt; {</span>
<span class="nc" id="L311">				final CellStyle cellStyle = workbook.createCellStyle();</span>
<span class="nc" id="L312">				dataFormat.ifPresent(format -&gt; cellStyle.setDataFormat(workbook.createDataFormat().getFormat(format)));</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">				if (simplifiedCellStyle != SimplifiedCellStyle.NORMAL) {</span>
<span class="nc" id="L314">					final Font font = workbook.createFont();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">					if (simplifiedCellStyle == SimplifiedCellStyle.BOLD) {</span>
<span class="nc" id="L316">						font.setBold(true);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">					} else if (simplifiedCellStyle == SimplifiedCellStyle.ITALIC) {</span>
<span class="nc" id="L318">						font.setItalic(true);</span>
					}
<span class="nc" id="L320">					cellStyle.setFont(font);</span>
				}
<span class="nc" id="L322">				return cellStyle;</span>
			}));
		}

		@PackagePrivate
		void write() throws IOException {
<span class="nc" id="L328">			try (XSSFWorkbook workbook = new XSSFWorkbook()) {</span>
<span class="nc" id="L329">				workbook.setCellFormulaValidation(false);</span>
<span class="nc" id="L330">				writeProducts(workbook.createSheet(SHEET_NAME_BALANCES));</span>
<span class="nc" id="L331">				writeAccounts(workbook.createSheet(SHEET_NAME_ACCOUNTS));</span>
				// Auto Size Columns
<span class="nc" id="L333">				workbook.sheetIterator().forEachRemaining(sheet -&gt; {</span>
<span class="nc" id="L334">					final int numberOfColumns = sheet.getRow(0).getLastCellNum();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">					for (int columnIndex = 0; columnIndex &lt; numberOfColumns; columnIndex += 1) {</span>
<span class="nc" id="L336">						sheet.autoSizeColumn(columnIndex);</span>
						// Add the width of the auto filter
<span class="nc" id="L338">						final double widthOfHeader = SheetUtil.getColumnWidth(sheet, columnIndex, false, 0, 0);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">						if (widthOfHeader != -1) {</span>
<span class="nc" id="L340">							final int intWidth = (int) Math.round(Math.min(CHARACTER_WIDTH * widthOfHeader + AUTO_FILTER_WIDTH, COLUMN_MAX_WIDTH));</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">							if (intWidth &gt; sheet.getColumnWidth(columnIndex)) {</span>
<span class="nc" id="L342">								sheet.setColumnWidth(columnIndex, intWidth);</span>
							}
						}
					}
<span class="nc" id="L346">				});</span>
<span class="nc" id="L347">				workbook.write(outputStream);</span>
			}
<span class="nc" id="L349">		}</span>

		@SuppressWarnings(&quot;checkstyle:MagicNumber&quot;)
		private void writeProducts(final XSSFSheet sheet) {
<span class="nc" id="L353">			final Set&lt;Product&gt; products = Budgets.getProducts(budgets);</span>
<span class="nc" id="L354">			appendProducts(sheet, products);</span>
<span class="nc" id="L355">			appendProductBudgets(sheet, products);</span>
			// Table
<span class="nc" id="L357">			sheet.createFreezePane(3, 0);</span>
<span class="nc" id="L358">			final XSSFTable table = createTable(sheet, SHEET_NAME_BALANCES);</span>
<span class="nc" id="L359">			table.getCTTable().getTableStyleInfo().setShowRowStripes(true);</span>
			// Totals Row
<span class="nc" id="L361">			table.setDataRowCount(table.getDataRowCount() + 1);</span>
<span class="nc" id="L362">			appendProductsTotalsRow(appendRow(sheet), table.getCTTable());</span>
<span class="nc" id="L363">		}</span>

		private void appendProducts(final Sheet sheet, final Set&lt;Product&gt; products) {
			// Headers
<span class="nc" id="L367">			appendStrings(appendRow(sheet), COLUMN_NAME_COMMUNITY, COLUMN_NAME_BALANCE, COLUMN_NAME_DESCRIPTION, COLUMN_NAME_SUM);</span>
			// Values
<span class="nc bnc" id="L369" title="All 2 branches missed.">			for (final Product product : products) {</span>
<span class="nc" id="L370">				final Row row = appendRow(sheet);</span>
<span class="nc" id="L371">				appendNumber(row, OptionalInt.of(product.getMunicipality().getId()));</span>
<span class="nc" id="L372">				appendNumber(row, OptionalInt.of(product.getId()));</span>
<span class="nc" id="L373">				appendString(row, product.getDescription());</span>
<span class="nc" id="L374">				appendBoolean(row, true);</span>
<span class="nc" id="L375">			}</span>
<span class="nc" id="L376">		}</span>

		private void appendProductBudgets(final XSSFSheet sheet, final Set&lt;Product&gt; products) {
<span class="nc bnc" id="L379" title="All 2 branches missed.">			for (final Budget budget : budgets) {</span>
				// Header
<span class="nc" id="L381">				final Cell headerCell = appendString(sheet.getRow(0), getSimplifiedCellStyle(budget), getBudgetColumnName(budget));</span>
<span class="nc" id="L382">				addBudgetsComment(headerCell, budget);</span>
				// Balances
<span class="nc" id="L384">				int rowIndex = 1;</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">				for (int i = products.size(); i &gt; 0; i -= 1) {</span>
<span class="nc" id="L386">					appendFormula(sheet.getRow(rowIndex), getSimplifiedCellStyle(budget), DATA_FORMAT_CURRENCY, String.format(&quot;SUMIFS(%1$s[%7$s], %1$s[%3$s], %2$s[[#This Row],[%3$s]], %1$s[%4$s], %2$s[[#This Row],[%5$s]], %1$s[%6$s], TRUE)&quot;, SHEET_NAME_ACCOUNTS,  // 1</span>
					SHEET_NAME_BALANCES,  // 2
					COLUMN_NAME_BALANCE,  // 3
					COLUMN_NAME_BALANCE_DESCRIPTION,  // 4
					COLUMN_NAME_DESCRIPTION,  // 5
					COLUMN_NAME_SUM,  // 6
<span class="nc" id="L392">					getBudgetColumnName(budget))); // 7</span>
<span class="nc" id="L393">					rowIndex += 1;</span>
				}
<span class="nc" id="L395">			}</span>
<span class="nc" id="L396">		}</span>

		private void appendProductsTotalsRow(final Row row, final CTTable table) {
<span class="nc" id="L399">			final Iterator&lt;CTTableColumn&gt; columns = appendTotalsRow(row, table, 4);</span>
<span class="nc" id="L400">			appendSumsForBudgets(row, columns);</span>
<span class="nc" id="L401">		}</span>

		private void writeAccounts(final XSSFSheet sheet) {
<span class="nc" id="L404">			final Set&lt;Account&gt; accounts = Budgets.getAccounts(budgets);</span>
<span class="nc" id="L405">			appendAccounts(sheet, accounts);</span>
<span class="nc" id="L406">			appendAccountBudgets(sheet, accounts);</span>
			// Table
<span class="nc" id="L408">			final XSSFTable table = createTable(sheet, SHEET_NAME_ACCOUNTS);</span>
			// Totals Row
<span class="nc" id="L410">			table.setDataRowCount(table.getDataRowCount() + 1);</span>
<span class="nc" id="L411">			appendAccountsTotalsRow(appendRow(sheet), table.getCTTable());</span>
<span class="nc" id="L412">		}</span>

		private void appendAccounts(final Sheet sheet, final Set&lt;Account&gt; accounts) {
			// Headers
<span class="nc" id="L416">			final Row headerRow = appendRow(sheet);</span>
<span class="nc" id="L417">			appendStrings(headerRow, COLUMN_NAME_COMMUNITY, COLUMN_NAME_BALANCE, COLUMN_NAME_BALANCE_DESCRIPTION, COLUMN_NAME_ACCOUNT, COLUMN_NAME_ACCOUNT_DESCRIPTION, COLUMN_NAME_SUM);</span>
<span class="nc" id="L418">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.HEADER_MUNICIPALITY).getColumnIndex(), true);</span>
<span class="nc" id="L419">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.HEADER_PRODUCT_ID).getColumnIndex(), true);</span>
<span class="nc" id="L420">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.HEADER_PRODUCT_DESCRIPTION).getColumnIndex(), true);</span>
<span class="nc" id="L421">			sheet.setColumnHidden(appendString(headerRow, CsvFiles.HEADER_ACCOUNT).getColumnIndex(), true);</span>
			// Values
<span class="nc bnc" id="L423" title="All 2 branches missed.">			for (final Account account : accounts) {</span>
<span class="nc" id="L424">				final Row row = appendRow(sheet);</span>
<span class="nc" id="L425">				appendNumber(row, OptionalInt.of(account.getProduct().getMunicipality().getId()));</span>
<span class="nc" id="L426">				appendNumber(row, OptionalInt.of(account.getProduct().getId()));</span>
<span class="nc" id="L427">				appendString(row, account.getProduct().getDescription());</span>
<span class="nc" id="L428">				appendNumber(row, OptionalInt.of(account.getId()));</span>
<span class="nc" id="L429">				appendString(row, account.getDescription());</span>
<span class="nc" id="L430">				appendBoolean(row, true);</span>
<span class="nc" id="L431">				appendNumber(row, OptionalInt.of(account.getProduct().getMunicipality().getId()));</span>
<span class="nc" id="L432">				appendNumber(row, OptionalInt.of(account.getProduct().getId()));</span>
<span class="nc" id="L433">				appendString(row, account.getProduct().getDescription());</span>
<span class="nc" id="L434">				appendString(row, String.format(&quot;%d %s&quot;, account.getId(), account.getDescription()));</span>
<span class="nc" id="L435">			}</span>
<span class="nc" id="L436">		}</span>

		private void appendAccountBudgets(final XSSFSheet sheet, final Set&lt;Account&gt; accounts) {
<span class="nc bnc" id="L439" title="All 2 branches missed.">			for (final Budget budget : budgets) {</span>
				// Header
<span class="nc" id="L441">				final Cell headerCell = appendString(sheet.getRow(0), getSimplifiedCellStyle(budget), getBudgetColumnName(budget));</span>
<span class="nc" id="L442">				addBudgetsComment(headerCell, budget);</span>
				// Balances
<span class="nc" id="L444">				int rowIndex = 1;</span>
<span class="nc" id="L445">				final Map&lt;Account, Balance&gt; balances = budget.getBalances();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">				for (final Account account : accounts) {</span>
<span class="nc" id="L447">					final Optional&lt;Balance&gt; balance = Optional.ofNullable(balances.get(account));</span>
<span class="nc" id="L448">					appendNumber(sheet.getRow(rowIndex), getSimplifiedCellStyle(budget), DATA_FORMAT_CURRENCY, balance.map(Balance::getValue));</span>
<span class="nc" id="L449">					rowIndex += 1;</span>
<span class="nc" id="L450">				}</span>
<span class="nc" id="L451">			}</span>
<span class="nc" id="L452">		}</span>

		private void appendAccountsTotalsRow(final Row row, final CTTable table) {
<span class="nc" id="L455">			final Iterator&lt;CTTableColumn&gt; columns = appendTotalsRow(row, table, 10);</span>
<span class="nc" id="L456">			appendSumsForBudgets(row, columns);</span>
<span class="nc" id="L457">		}</span>

		private void appendSumsForBudgets(final Row row, final Iterator&lt;CTTableColumn&gt; columnsIterator) {
<span class="nc bnc" id="L460" title="All 2 branches missed.">			for (final Budget budget : budgets) {</span>
<span class="nc" id="L461">				columnsIterator.next().setTotalsRowFunction(STTotalsRowFunction.CUSTOM);</span>
<span class="nc" id="L462">				appendFormula(row, getSimplifiedCellStyle(budget), DATA_FORMAT_CURRENCY, String.format(&quot;SUMIFS(%1$s[%3$s], %1$s[%2$s], TRUE)&quot;, SHEET_NAME_BALANCES, COLUMN_NAME_SUM, getBudgetColumnName(budget)));</span>
<span class="nc" id="L463">			}</span>
<span class="nc" id="L464">		}</span>

		@java.lang.SuppressWarnings(&quot;all&quot;)
		@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
		@lombok.Generated
		ExcelFileWriter(final List&lt;Budget&gt; budgets, final OutputStream outputStream) {
			this.budgets = budgets;
			this.outputStream = outputStream;
		}
	}


<span class="nc" id="L476">	@SuppressWarnings(&quot;PMD.UnnecessaryModifier&quot;)</span>
	private static enum SimplifiedCellStyle {
<span class="nc" id="L478">		BOLD, ITALIC, NORMAL;</span>
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	private ExcelFiles() {
		throw new java.lang.UnsupportedOperationException(&quot;This is a utility class and cannot be instantiated&quot;);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>